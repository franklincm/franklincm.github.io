<!DOCTYPE html>
<html>
    <head>
      <meta charset="UTF-8">
      <!-- Bootstrap -->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" media="screen" href="/css/bootstrap.min.css">
      <link href="/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
      <!-- syntax highlighting -->
      <link rel="stylesheet" href="/css/pygments/native.css">
      <!-- Overrides -->
      <link rel="stylesheet" href="/css/layout.css">
      <link rel="stylesheet" href="/css/chemistryregular.css">
      <link rel="stylesheet" href="/css/solarized-light.css">
      <link rel="stylesheet" href="/css/navtree-ascii-solarized-light.css">
      <link rel="stylesheet" href="/css/powerline-solarized-light.css">
      <link rel="icon" href="/img/favicon.ico?v=2" sizes="16x16 24x24 32x32 64x64" type="image/vnd.microsoft.icon">
      <!-- mathjax -->
      <script type="text/javascript" src="/js/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <title>Securing keys with weechat-fish - miscBitsOfData</title>
    </head>
    <body>

        <div class="container">
            <a href="/"><h1 class="title">// miscbitsofdata</h1></a>

            <div class="main">
                <div class="side">
		    <div class="navtree-ascii">
    <span class="nav drop">[-]&nbsp;~/<br />
	&nbsp;|~&nbsp;<a href="/">posts</a><br />
        &nbsp;|&nbsp;&nbsp;|<br />
	&nbsp;|&nbsp;&nbsp;`-<a href="/by-year">by year</a><br />
        &nbsp;|<br />
	&nbsp;|~&nbsp;odds & ends<br />
        &nbsp;|&nbsp;&nbsp;|<br />
	&nbsp;|&nbsp;&nbsp;`-<a href="/calendar/index.php">calendar</a><br />
	&nbsp;|<br />
	&nbsp;`~&nbsp;<a href="/tags/index.html">tags</a><br />
    </span>
    <span class="nav fill">
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
      ~<br />
    </span>
</div>

                </div>
                <div class="view ">
                    <div class="content">
			<div class="post">
    <h1>Securing keys with weechat-fish</h1>
    <date>28 Feb 2014</date>
    
    <author>Author: <span>chase</span></author>
    
    <hr />
    <p>I recently made the switch from <a href="http://www.irssi.org/">irssi</a> to <a href="http://www.weechat.org/">weechat</a>. As it turns out, weechat rocks. I had been using <a href="https://github.com/falsovsky/FiSH-irssi">FiSH-irssi</a> for encrypting certain channels/conversations with blowfish and luckily there was already a similar plugin for weechat: <a href="https://github.com/freshprince/weechat-fish">weechat-fish</a>.</p>

<p>In weechat:
<figure class="code"><figcaption></figcaption>
<div class="highlight"><pre><code class="bash">/script install fish.py
</code></pre></div>
</figure></p>

<p>Then I simply set keys appropriately:
<figure class="code"><figcaption></figcaption>
<div class="highlight"><pre><code class="bash">/blowkey <span class="nb">set</span> <span class="se">#</span>miscbitsofdata wxg0iTM6dzU/1D55SgHmwjesSlCYmXRpHueA0OeSZQU<span class="o">=</span>
</code></pre></div>
</figure>
*<em>not my actual key</em></p>

<p>Everything works great. I especially like that the script displays alerts when encyrption is enabled/disabled, but I did notice that it was storing the keys in plaintext like so:</p>

<figure class="code"><figcaption></figcaption>
<div class="highlight"><pre><code class="bash"><span class="c">#</span>
<span class="c"># fish.conf -- weechat v0.4.3</span>
<span class="c">#</span>

<span class="o">[</span>look<span class="o">]</span>
<span class="nv">announce</span> <span class="o">=</span> on
<span class="nv">mark_encrypted</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
<span class="nv">mark_position</span> <span class="o">=</span> off
<span class="nv">marker</span> <span class="o">=</span> <span class="s2">&quot;O&lt;&quot;</span>

<span class="o">[</span>color<span class="o">]</span>
<span class="nv">alert</span> <span class="o">=</span> lightblue

<span class="o">[</span>keys<span class="o">]</span>
/#miscbitsofdata <span class="o">=</span> wxg0iTM6dzU/1D55SgHmwjesSlCYmXRpHueA0OeSZQU<span class="o">=</span>
</code></pre></div>
</figure>

<p>Obviously, this is a concern. I suspect this was simply an oversight on the part of the original developers since <a href="https://github.com/falsovsky/FiSH-irssi">FiSH-irssi</a> stores hashes of the keys.</p>

<p>By now I was thoroughly hooked on weechat so going back to <a href="http://www.irssi.org/">irssi</a> wasn&#39;t an option. One of the many benefits of open sourcing code is that if you need something else, there&#39;s nothing stopping you from changing it. So I spent a few days reading through the source code for <a href="https://github.com/falsovsky/FiSH-irssi">fish-irssi</a>, <a href="https://github.com/freshprince/weechat-fish">weechat-fish</a>, and the <a href="http://www.weechat.org/files/doc/stable/weechat_plugin_api.en.html#_weechat_config_option_set">weechat API reference</a>.</p>

<p>Playing around in the python interpreter and taking cues from <a href="https://github.com/falsovsky/FiSH-irssi">FiSH-irssi</a>, I decided to hash and salt a user supplied passphrase to generate a key, encrypt/decrypt the blowfish keys with the new key, then hash and salt the new key again and store the salt and the resulting hash in  ~/.weechat/fish.conf. Then when restarting weechat, if a hash is present in the config file, it prompts for a passphrase, hashes and salts to generate the key, hashes and salts the key and compares that with the hash in the config file. If the hashes match, the key is good and the blowfish keys are decrypted. Otherwise the plugin unloads itself. That way the key only ever exists in memory while the plugin is loaded. I don&#39;t think there&#39;s much I can do about securing the memory in python, but as long as the keys aren&#39;t just sitting there in the open I&#39;m ok with this solution.</p>

<p>The resulting ~/.weechat/fish.conf looks something like this:</p>

<figure class="code"><figcaption></figcaption>
<div class="highlight"><pre><code class="bash"><span class="c">#</span>
<span class="c"># fish.conf -- weechat v0.4.3</span>
<span class="c">#</span>

<span class="o">[</span>look<span class="o">]</span>
<span class="nv">announce</span> <span class="o">=</span> on
<span class="nv">mark_encrypted</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
<span class="nv">mark_position</span> <span class="o">=</span> off
<span class="nv">marker</span> <span class="o">=</span> <span class="s2">&quot;O&lt;&quot;</span>

<span class="o">[</span>color<span class="o">]</span>
<span class="nv">alert</span> <span class="o">=</span> lightblue

<span class="o">[</span>lock<span class="o">]</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="s2">&quot;nFrBZ0ypPsI1D1/0q.Ju7XN/wdDTw0L4fh119aJzT.KH7Sd0&quot;</span>
<span class="nv">salt</span> <span class="o">=</span> <span class="s2">&quot;JO6e0gcpLqz0mRz.g/6W5Ke/&quot;</span>

<span class="o">[</span>keys<span class="o">]</span>
/#miscbitsofdata <span class="o">=</span> +OK 5S4qH0vajU9/qT1d1241Mm6OL/F0ap//FUy7E1.Z4MA0tanM90DnhYE8UqQhZ05U.nGe.KS59w.
</code></pre></div>
</figure>

<p><a href="https://github.com/freshprince/weechat-fish">weechat-fish</a> already uses the <a href="https://www.dlitz.net/software/pycrypto/">Python Cryptography Toolkit</a> so I only needed to import PBKDF2 and get writing. A couple hundred lines later and <a href="https://github.com/gnullbyte/weechat-fish">here is the (semi) finished product.</a></p>

<p>I&#39;ve submitted a pull request to the original authors so I haven&#39;t submitted it to weechat scripts yet, but I intend to if it isn&#39;t something they wish to merge.</p>

    <hr />

    
    <p><span>Chase Franklin</span> : <a href="https://github.com/gnullbyte">github.com/gnullbyte</a><br/>
<pre class="contact">echo sjtqnjm.pvjru@lxv | tr a-z@. r-za-q.@</pre><br /></p>

    
    <span class="random">/dev/random</span>
    <blockquote class="fortune"><pre>Oh, you think you're doing some damage? Two plus two is [static] â€¦
ten. In base four! I'm fine!
</pre></blockquote>
</div>

                    </div>
                </div>

            </div> <!-- main -->
	    <div class="powerline">
  <div class="text-left1">
    <a href="">&nbsp; mbod </a>
  </div>
  <div class="l1"></div>
  <div class="text-left2 hidden-xs hidden-sm ">Securing-keys-with-weechat-fish.html</div>
  <div class="l2"></div>
  <div class="git"></div>
  <div class="text-left3 hidden-xs">&nbsp;working</div>
  <div class="l3"></div>
  <div class="text-left4 hidden-xs">current</div>
  <div class="l4"></div>
  <span class=""><!-- center text --></span>
  <div class="text-right1">linux&nbsp;</div>
  <div class="r1"></div>
  <div class="text-right2 hidden-xs">programming</div>
  <div class="r2"></div>
  <div class="text-right3 hidden-xs hidden-sm">rants</div>
  <div class="r3"></div>
</div>

            <div class="footer">&copy; 2014 miscbitsofdata.com</div>
        </div><!-- container -->

      <!--  bootstrap js  -->
<script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/eHeight.js"></script>
<script type="text/javascript" src="/js/aHeight.js"></script>
<!-- <script type="text/javascript" src="/js/fill.js"></script> -->

    </body>
</html>
